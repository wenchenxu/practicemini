<view class="page">
  <view class="header">{{city}} · 车辆中心</view>

  <view class="search-bar">
    <input class="search-input" placeholder="车牌号 / 司机名 / 车架号" value="{{searchKeyword}}" bindinput="onSearchInput" />
    <button wx:if="{{searchKeyword}}" class="search-clear" size="mini" bindtap="onSearchClear">清除</button>
  </view>

  <view class="filter-bar">
    <view class="filter-pill {{statusFilter==='all' ? 'active' : ''}}" data-status="all" bindtap="onStatusFilterTap">
      <view>全部</view>
      <view class="count">{{counts.all || 0}}</view>
    </view>
    <view class="filter-pill {{statusFilter==='available' ? 'active' : ''}}" data-status="available" bindtap="onStatusFilterTap">
      <view>闲置</view>
      <view class="count">{{counts.available || 0}}</view>
    </view>
    <view class="filter-pill {{statusFilter==='rented' ? 'active' : ''}}" data-status="rented" bindtap="onStatusFilterTap">
      <view>已租</view>
      <view class="count">{{counts.rented || 0}}</view>
    </view>
    <view class="filter-pill {{statusFilter==='maintenance' ? 'active' : ''}}" data-status="maintenance" bindtap="onStatusFilterTap">
      <view>维修</view>
      <view class="count">{{counts.maintenance || 0}}</view>
    </view>
    
    <view class="filter-pill {{statusFilter==='insurance' ? 'active' : ''}}" data-status="insurance" bindtap="onStatusFilterTap">
      <view>保险</view>
      <view class="count count-warn">{{counts.insurance || 0}}</view>
    </view>
    <view class="filter-pill {{statusFilter==='annual' ? 'active' : ''}}" data-status="annual" bindtap="onStatusFilterTap">
      <view>年审</view>
      <view class="count count-warn">{{counts.annual || 0}}</view>
    </view>

    <view class="filter-pill {{statusFilter==='misc' ? 'active' : ''}}" data-status="misc" bindtap="onStatusFilterTap">
      <view>其他</view>
      <view class="count">{{counts.misc || 0}}</view>
    </view>
  </view>

  <view wx:if="{{loading && (!list || list.length === 0)}}" class="loading">加载中…</view>
  <view wx:elif="{{!loading && (!list || list.length === 0)}}" class="empty">暂无车辆数据</view>

  <block wx:for="{{list}}" wx:key="_id">
    <view class="item" bindtap="toDetail" data-id="{{item._id}}">
      <view class="row">
        <text class="plate">{{item.plate}}</text>
        <view class="status-tags">
          <view class="status-tag status-{{item.rentStatus === 'rented' ? 'rented' : 'available'}}">
            {{ item.rentStatus === 'rented' ? '已租' : '闲置' }}
          </view>
          <text wx:if="{{item.maintenanceStatus === 'in_maintenance'}}" class="status-tag status-maintenance">维修</text>
        </view>
      </view>

      <view class="row2">
        <text class="model">{{item.model || '车型'}} {{item.color}}</text>
        
        <view class="expiry-group">
          <view wx:if="{{item.liabExpiry}}" class="expiry-text {{item.liabExpiry.type}}">
            {{item.liabExpiry.text}}
          </view>
          <view wx:if="{{item.commExpiry}}" class="expiry-text {{item.commExpiry.type}}">
            {{item.commExpiry.text}}
          </view>
        </view>
      </view>

      <view class="row3 driver-row">
        <view class="driver-info">
          <view class="driver-col-name">
            {{ item.driverName ? ('司机：' + item.driverName) : '当前无司机' }}
          </view>
          <view class="driver-col-phone" wx:if="{{item.currentDriverPhone}}">
            {{ item.currentDriverPhone }}
          </view>
        </view>
        
        <view wx:if="{{item.annualExpiry}}" class="expiry-text {{item.annualExpiry.type}}">
          {{item.annualExpiry.text}}
        </view>
      </view>
    </view>
  </block>

  <view wx:if="{{list && list.length>0}}" class="list-footer">
    <text wx:if="{{loading}}">加载中...</text>
    <text wx:elif="{{!hasMore}}">已到底</text>
  </view>
</view>