<!--pages/contract-detail/index.wxml-->
<wxs module="tools">
  module.exports.includes = function(arr, item) {
    if (!arr) return false;
    return arr.indexOf(item) > -1;
  }
</wxs>
<wxs src="../../utils/fmt.wxs" module="fmt" />
<view class="container">
  <view class="header-section">
    <view class="title">合同详情</view>
    <view class="sub-title">编号：{{contract.contractSerialNumber || '-'}}</view>
  </view>

  <block wx:if="{{contract}}">
    
    <view class="info-list">
      <view class="item">
        <text class="label">司机姓名</text>
        <text class="value">{{contract.clientName || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">司机手机号</text>
        <text class="value">{{contract.clientPhone || '-'}}</text>
      </view>

      <view class="divider"></view>

      <view class="item">
        <text class="label">合同类型</text>
        <text class="value">{{contract.contractTypeName || contract.contractType || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">合同生效日期</text>
        <text class="value">{{contract.contractValidPeriodStart || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">合同结束日期</text>
        <text class="value">{{contract.contractValidPeriodEnd || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">租期</text>
        <text class="value">{{contract.rentDurationMonth || 0}} 个月</text>
      </view>

      <view class="divider"></view>

      <view class="item">
        <text class="label">月租金</text>
        <text class="value">¥ {{contract.rentMonthly || 0}}</text>
      </view>

      <view class="item">
        <text class="label">首日支付金</text>
        <text class="value">¥ {{contract.rentToday || 0}}</text>
      </view>

      <view class="item">
        <text class="label">每月支付日</text>
        <text class="value">{{contract.rentPaybyDayInMonth || '-'}} 号</text>
      </view>

      <view class="item">
        <text class="label">押金总额</text>
        <text class="value">¥ {{contract.deposit || 0}}</text>
      </view>

      <block wx:if="{{contract.contractType === 'rent_rto'}}">
        <view class="divider"></view>
        <view class="item">
            <text class="label">约定购车款</text>
            <text class="value">¥ {{contract.sellPrice || 0}}</text>
        </view>
        <view class="item">
            <text class="label">销售备注</text>
            <text class="value">{{contract.notesWhenSell || '无'}}</text>
        </view>
      </block>
    </view>

    <view class="edit-card">
      <view class="card-header-row">
        <view class="section-title" style="margin-bottom:0; border:none; padding:0;">车辆信息</view>
        <van-button 
        type="warning" 
        size="small" 
        plain 
        bind:click="onOpenSwapModal"
        wx:if="{{contract && !contract.deleted}}"
        >更换车辆</van-button>
        </view>

      <view class="read-row">
        <text class="label">当前车牌号</text>
        <text class="value" style="font-weight:bold; color:#333;">{{ contract.fields.carPlate }}</text>
      </view>

      <view class="read-row">
        <text class="label">车辆更换次数</text>
        <text class="value">{{ contract.swapHistory.length || 0 }} 次</text>
      </view>

      <view class="read-row">
        <text class="label">换车历史</text>
      </view>
      <view style="margin: 20rpx 30rpx 30rpx 30rpx;">        
        <view style="border: 1rpx solid #ebedf0; border-radius: 12rpx; overflow: hidden;">
          <view style="background: #f7f8fa; padding: 16rpx 24rpx; display: flex; justify-content: space-between; font-size: 24rpx; color: #999;">
            <text>原车牌</text>
            <text>更换原因</text>
          </view>

          <block wx:if="{{ contract.swapHistory && contract.swapHistory.length > 0 }}">
            <view 
              wx:for="{{contract.swapHistory}}" 
              wx:key="index" 
              style="display: flex; justify-content: space-between; align-items: center; padding: 24rpx; border-bottom: 1rpx solid #f5f5f5; background: #fff;"
            >
              <view>
                <view style="font-size: 28rpx; font-weight: bold; color: #333;">{{item.oldCar.plate}}</view>
                <view style="font-size: 22rpx; color: #999; margin-top: 6rpx;">{{fmt.formatDate(item.date)}}</view>
              </view>
              
              <view style="font-size: 26rpx; color: #666; max-width: 60%; text-align: right; line-height: 1.4;">
                {{item.reason || '-'}}
              </view>
            </view>
          </block>

          <block wx:else>
             <view style="padding: 40rpx; text-align: center; color: #ccc; font-size: 26rpx; background: #fff;">
               暂无历史换车记录
             </view>
          </block>
        </view>
      </view>
    </view>

    <view class="edit-card">
      <view class="card-header-row">
        <view class="section-title" style="margin-bottom:0; border:none; padding:0;">租金支付设置</view>
        <van-button type="primary" size="small" plain round bind:click="onOpenRentEdit">编辑</van-button>
      </view>

      <view class="read-row">
        <text class="label">支付频率</text>
        <text class="value">{{ rentFrequencyMap[rentPayFrequency] || '-' }}</text>
      </view>

      <view class="read-row" style="border-bottom:none;">
        <text class="label">支付日期</text>
        <view class="value" wx:if="{{rentPayFrequency === 'day'}}">每日支付</view>
        <view class="value" wx:elif="{{rentPayFrequency === 'week'}}">{{ rentPayDates[0] || '-' }}</view>
        <view class="value" wx:else>
           {{ rentPayDates && rentPayDates.length > 0 ? rentPayDates + ' 号' : '-' }}
        </view>
      </view>
    </view>
    <van-dialog
      use-slot
      title="设置支付周期"
      show="{{ showRentEditModal }}"
      show-cancel-button="{{ false }}" 
      show-confirm-button="{{ false }}"
      bind:close="onCloseRentEdit"
    >
      <view class="dialog-content">
        
        <view class="form-column">
          <view class="label" style="margin-bottom:16rpx;">租金类型</view>
          <view class="radio-group">
            <view 
              class="radio-tag {{editRentFrequency === 'month' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="month">按月</view>
            <view 
              class="radio-tag {{editRentFrequency === 'week' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="week">按周</view>
            <view 
              class="radio-tag {{editRentFrequency === 'day' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="day">按日</view>
          </view>
        </view>

        <view class="form-column" style="margin-top:20rpx;">
          <view class="label" style="margin-bottom:16rpx;">日期选择</view>
          
          <block wx:if="{{editRentFrequency === 'month'}}">
            <view class="month-grid">
              <block wx:for="{{28}}" wx:key="index">
                <view 
                  class="grid-num {{tools.includes(editRentDates, item + 1) ? 'selected' : ''}}" 
                  bindtap="onToggleMonthDate" 
                  data-day="{{item + 1}}"
                >
                  {{item + 1}}
                </view>
              </block>
            </view>
            <view class="tips">* 已自动屏蔽 29, 30, 31 号</view>
          </block>

          <block wx:elif="{{editRentFrequency === 'week'}}">
            <view class="week-list">
              <view class="radio-tag {{editRentDates[0] === '周一' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周一">周一</view>
              <view class="radio-tag {{editRentDates[0] === '周二' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周二">周二</view>
              <view class="radio-tag {{editRentDates[0] === '周三' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周三">周三</view>
              <view class="radio-tag {{editRentDates[0] === '周四' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周四">周四</view>
              <view class="radio-tag {{editRentDates[0] === '周五' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周五">周五</view>
              <view class="radio-tag {{editRentDates[0] === '周六' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周六">周六</view>
              <view class="radio-tag {{editRentDates[0] === '周日' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周日">周日</view>
            </view>
          </block>

          <block wx:else>
            <view class="static-text">每日支付，无需选择日期</view>
          </block>

        </view>

        <view class="dialog-footer">
          <van-button type="default" size="large" custom-style="flex:1; margin-right:20rpx;" bind:click="onCloseRentEdit">取消</van-button>
          <van-button type="info" size="large" custom-style="flex:1;" loading="{{ savingRent }}" bind:click="onConfirmRentEdit">保存设置</van-button>
        </view>

      </view>
    </van-dialog>

    <view class="edit-card">
      <view class="card-header-row">
        <view class="section-title" style="margin-bottom:0; border:none; padding:0;">赠送延长天数</view>
        <van-button type="primary" size="small" plain round bind:click="onOpenEdit">编辑</van-button>
      </view>
      
      <view class="read-row">
        <text class="label">赠送天数</text>
        <text class="value">{{giftDays || 0}} 天</text>
      </view>

      <view class="read-row">
        <text class="label">合同结束实际日期</text>
        <text class="value" style="font-weight:bold;">{{contractRealEndDate || '-'}}</text>
      </view>

      <view class="read-column">
        <text class="label">备注信息</text>
        <view class="value-box">
          {{giftDaysNotes || '无备注'}}
        </view>
      </view>
    </view>

  </block>
  <view wx:else class="loading">
    加载中...
  </view>

  <van-dialog
    use-slot
    title="编辑延长设置"
    show="{{ showEditModal }}"
    show-cancel-button="{{ false }}" 
    show-confirm-button="{{ false }}"
    bind:close="onCloseEdit"
  >
    <view class="dialog-content">
      <view class="form-row">
        <view class="label">赠送天数</view>
        <input 
          class="input" 
          type="number" 
          placeholder="0" 
          value="{{editGiftDays}}" 
          bindinput="onEditDaysInput"
        />
        <view class="unit">天</view>
      </view>

      <view class="form-row">
        <view class="label">预计结束</view>
        <view class="value-read">{{editRealEndDate || '-'}}</view>
      </view>

      <view class="form-column">
        <view class="label">备注信息 ({{editGiftNotes.length || 0}}/300)</view>
        <textarea 
          class="textarea" 
          placeholder="请输入备注信息..." 
          maxlength="300" 
          value="{{editGiftNotes}}" 
          bindinput="onEditNotesInput"
          fixed="true"
        ></textarea>
      </view>

      <view class="dialog-footer">
        <van-button 
            type="default" 
            size="large" 
            custom-style="flex:1; margin-right:20rpx;" 
            bind:click="onCloseEdit"
        >取消</van-button>
        
        <van-button 
            type="info" 
            size="large" 
            custom-style="flex:1;" 
            loading="{{ saving }}" 
            bind:click="onConfirmEdit"
        >确定保存</van-button>
      </view>

    </view>
  </van-dialog>
</view>

<van-popup
  show="{{ showSwapModal }}"
  position="bottom"
  custom-style="height: 60%;"
  bind:close="onCloseSwapModal"
  closeable
>
  <view class="swap-container" style="padding: 30rpx; padding-top: 80rpx;">
    <view class="section-title">办理换车</view>
    
    <view class="form-item">
      <view class="label">换车原因 <text style="color:red">*</text></view>
      <textarea 
        class="textarea" 
        placeholder="例如：原车故障、司机要求升级车型..." 
        value="{{swapReason}}" 
        bindinput="onInputSwapReason"
        style="height: 120rpx; background:#f5f5f5; width:100%; padding:20rpx; border-radius:8rpx; box-sizing:border-box;"
      ></textarea>
    </view>

    <view class="form-item" style="margin-top:30rpx;">
      <view class="label">选择新车 ({{availableVehicles.length}} 辆可用) <text style="color:red">*</text></view>
      
      <view wx:if="{{loadingVehicles}}" style="color:#999; font-size:24rpx; padding:20rpx;">加载可用车辆中...</view>
      
      <view wx:elif="{{availableVehicles.length === 0}}" style="color:#f56c6c; padding:20rpx;">
        当前城市 ({{contract.cityName}}) 无可用车辆
      </view>

      <radio-group bindchange="onSelectNewVehicle" style="max-height: 400rpx; overflow-y: auto; display:block;">
        <label class="vehicle-item" wx:for="{{availableVehicles}}" wx:key="_id" style="display:flex; justify-content:space-between; padding:20rpx 0; border-bottom:1rpx solid #eee;">
          <view>
            <view style="font-weight:bold;">{{item.plate}}</view>
            <view style="font-size:24rpx; color:#666;">{{item.model}} | {{item.color}}</view>
          </view>
          <radio value="{{item._id}}" checked="{{selectedNewVehicleId === item._id}}" color="#1989fa"/>
        </label>
      </radio-group>
    </view>

    <view style="margin-top: 40rpx;">
      <van-button type="info" block round bind:click="onPreConfirmSwap" loading="{{swapping}}">确认换车</van-button>
    </view>
  </view>
</van-popup>

<van-dialog
  use-slot
  title="确认换车信息"
  show="{{ showSwapConfirmDialog }}"
  show-cancel-button
  bind:close="onCloseSwapConfirmDialog"
  bind:confirm="onRealConfirmSwap"
>
  <view style="padding: 40rpx 40rpx; font-size: 28rpx; line-height: 1.8; color: #333;">
    <view style="display:flex; justify-content:space-between;">
      <text style="color:#666;">原车辆：</text>
      <text style="font-weight:bold;">{{contract.fields.carPlate}}</text>
    </view>
    <view style="display:flex; justify-content:space-between;">
      <text style="color:#666;">新车辆：</text>
      <text style="font-weight:bold; color: #1989fa;">{{selectedNewVehiclePlate}}</text>
    </view>
    <view style="margin-top:10rpx;">
      <text style="color:#666;">换车原因：</text>
      <view style="background:#f7f8fa; padding:10rpx 20rpx; border-radius:8rpx; margin-top:6rpx; color:#333;">{{swapReason}}</view>
    </view>
    
    <view style="margin-top: 30rpx; padding-top:20rpx; border-top:1rpx dashed #eee; color:#f56c6c; font-size:24rpx; text-align:center;">
      ⚠️ 确认后旧车将自动退租，新车自动起租
    </view>
  </view>
</van-dialog>