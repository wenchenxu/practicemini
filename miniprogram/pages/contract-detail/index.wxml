<!--pages/contract-detail/index.wxml-->
<wxs module="tools">
  module.exports.includes = function(arr, item) {
    if (!arr) return false;
    return arr.indexOf(item) > -1;
  }
</wxs>
<view class="container">
  <view class="header-section">
    <view class="title">合同详情</view>
    <view class="sub-title">编号：{{contract.contractSerialNumber || '-'}}</view>
  </view>

  <block wx:if="{{contract}}">
    
    <view class="info-list">
      <view class="item">
        <text class="label">司机姓名</text>
        <text class="value">{{contract.clientName || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">司机手机号</text>
        <text class="value">{{contract.clientPhone || '-'}}</text>
      </view>

      <view class="divider"></view>

      <view class="item">
        <text class="label">合同类型</text>
        <text class="value">{{contract.contractTypeName || contract.contractType || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">合同生效日期</text>
        <text class="value">{{contract.contractValidPeriodStart || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">合同结束日期</text>
        <text class="value">{{contract.contractValidPeriodEnd || '-'}}</text>
      </view>

      <view class="item">
        <text class="label">租期</text>
        <text class="value">{{contract.rentDurationMonth || 0}} 个月</text>
      </view>

      <view class="divider"></view>

      <view class="item">
        <text class="label">月租金</text>
        <text class="value">¥ {{contract.rentMonthly || 0}}</text>
      </view>

      <view class="item">
        <text class="label">首日支付金</text>
        <text class="value">¥ {{contract.rentToday || 0}}</text>
      </view>

      <view class="item">
        <text class="label">每月支付日</text>
        <text class="value">{{contract.rentPaybyDayInMonth || '-'}} 号</text>
      </view>

      <view class="item">
        <text class="label">押金总额</text>
        <text class="value">¥ {{contract.deposit || 0}}</text>
      </view>

      <block wx:if="{{contract.contractType === 'rent_rto'}}">
        <view class="divider"></view>
        <view class="item">
            <text class="label">约定购车款</text>
            <text class="value">¥ {{contract.sellPrice || 0}}</text>
        </view>
        <view class="item">
            <text class="label">销售备注</text>
            <text class="value">{{contract.notesWhenSell || '无'}}</text>
        </view>
      </block>
    </view>

    <view class="edit-card">
      <view class="card-header-row">
        <view class="section-title" style="margin-bottom:0; border:none; padding:0;">租金支付设置</view>
        <van-button type="primary" size="small" plain round bind:click="onOpenRentEdit">编辑</van-button>
      </view>

      <view class="read-row">
        <text class="label">支付频率</text>
        <text class="value">{{ rentFrequencyMap[rentPayFrequency] || '-' }}</text>
      </view>

      <view class="read-row" style="border-bottom:none;">
        <text class="label">支付日期</text>
        <view class="value" wx:if="{{rentPayFrequency === 'day'}}">每日支付</view>
        <view class="value" wx:elif="{{rentPayFrequency === 'week'}}">{{ rentPayDates[0] || '-' }}</view>
        <view class="value" wx:else>
           {{ rentPayDates && rentPayDates.length > 0 ? rentPayDates + ' 号' : '-' }}
        </view>
      </view>
    </view>
    <van-dialog
      use-slot
      title="设置支付周期"
      show="{{ showRentEditModal }}"
      show-cancel-button="{{ false }}" 
      show-confirm-button="{{ false }}"
      bind:close="onCloseRentEdit"
    >
      <view class="dialog-content">
        
        <view class="form-column">
          <view class="label" style="margin-bottom:16rpx;">租金类型</view>
          <view class="radio-group">
            <view 
              class="radio-tag {{editRentFrequency === 'month' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="month">按月</view>
            <view 
              class="radio-tag {{editRentFrequency === 'week' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="week">按周</view>
            <view 
              class="radio-tag {{editRentFrequency === 'day' ? 'active' : ''}}" 
              bindtap="onChangeFrequency" data-type="day">按日</view>
          </view>
        </view>

        <view class="form-column" style="margin-top:20rpx;">
          <view class="label" style="margin-bottom:16rpx;">日期选择</view>
          
          <block wx:if="{{editRentFrequency === 'month'}}">
            <view class="month-grid">
              <block wx:for="{{28}}" wx:key="index">
                <view 
                  class="grid-num {{tools.includes(editRentDates, item + 1) ? 'selected' : ''}}" 
                  bindtap="onToggleMonthDate" 
                  data-day="{{item + 1}}"
                >
                  {{item + 1}}
                </view>
              </block>
            </view>
            <view class="tips">* 已自动屏蔽 29, 30, 31 号</view>
          </block>

          <block wx:elif="{{editRentFrequency === 'week'}}">
            <view class="week-list">
              <view class="radio-tag {{editRentDates[0] === '周一' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周一">周一</view>
              <view class="radio-tag {{editRentDates[0] === '周二' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周二">周二</view>
              <view class="radio-tag {{editRentDates[0] === '周三' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周三">周三</view>
              <view class="radio-tag {{editRentDates[0] === '周四' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周四">周四</view>
              <view class="radio-tag {{editRentDates[0] === '周五' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周五">周五</view>
              <view class="radio-tag {{editRentDates[0] === '周六' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周六">周六</view>
              <view class="radio-tag {{editRentDates[0] === '周日' ? 'active' : ''}}" bindtap="onSelectWeekDay" data-day="周日">周日</view>
            </view>
          </block>

          <block wx:else>
            <view class="static-text">每日支付，无需选择日期</view>
          </block>

        </view>

        <view class="dialog-footer">
          <van-button type="default" size="large" custom-style="flex:1; margin-right:20rpx;" bind:click="onCloseRentEdit">取消</van-button>
          <van-button type="info" size="large" custom-style="flex:1;" loading="{{ savingRent }}" bind:click="onConfirmRentEdit">保存设置</van-button>
        </view>

      </view>
    </van-dialog>

    <view class="edit-card">
      <view class="card-header-row">
        <view class="section-title" style="margin-bottom:0; border:none; padding:0;">赠送延长天数</view>
        <van-button type="primary" size="small" plain round bind:click="onOpenEdit">编辑</van-button>
      </view>
      
      <view class="read-row">
        <text class="label">赠送天数</text>
        <text class="value">{{giftDays || 0}} 天</text>
      </view>

      <view class="read-row">
        <text class="label">合同结束实际日期</text>
        <text class="value" style="font-weight:bold;">{{contractRealEndDate || '-'}}</text>
      </view>

      <view class="read-column">
        <text class="label">备注信息</text>
        <view class="value-box">
          {{giftDaysNotes || '无备注'}}
        </view>
      </view>
    </view>

  </block>
  <view wx:else class="loading">
    加载中...
  </view>

  <van-dialog
    use-slot
    title="编辑延长设置"
    show="{{ showEditModal }}"
    show-cancel-button="{{ false }}" 
    show-confirm-button="{{ false }}"
    bind:close="onCloseEdit"
  >
    <view class="dialog-content">
      <view class="form-row">
        <view class="label">赠送天数</view>
        <input 
          class="input" 
          type="number" 
          placeholder="0" 
          value="{{editGiftDays}}" 
          bindinput="onEditDaysInput"
        />
        <view class="unit">天</view>
      </view>

      <view class="form-row">
        <view class="label">预计结束</view>
        <view class="value-read">{{editRealEndDate || '-'}}</view>
      </view>

      <view class="form-column">
        <view class="label">备注信息 ({{editGiftNotes.length || 0}}/300)</view>
        <textarea 
          class="textarea" 
          placeholder="请输入备注信息..." 
          maxlength="300" 
          value="{{editGiftNotes}}" 
          bindinput="onEditNotesInput"
          fixed="true"
        ></textarea>
      </view>

      <view class="dialog-footer">
        <van-button 
            type="default" 
            size="large" 
            custom-style="flex:1; margin-right:20rpx;" 
            bind:click="onCloseEdit"
        >取消</van-button>
        
        <van-button 
            type="info" 
            size="large" 
            custom-style="flex:1;" 
            loading="{{ saving }}" 
            bind:click="onConfirmEdit"
        >确定保存</van-button>
      </view>

    </view>
  </van-dialog>
</view>