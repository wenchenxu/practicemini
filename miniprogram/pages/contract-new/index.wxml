<wxs module="util">
  var def = function(val) {
    if (val === undefined || val === null || val === 'undefined' || val === '') {
      return '/';
    }
    return val;
  }
  module.exports.def = def;
</wxs>

<view class="container">
  <view class="section-card" wx:if="{{mode==='create'}}">
    <view class="card-title">åˆåŒåŸºç¡€é…ç½®</view>
    
    <view wx:if="{{showBranchPicker}}" class="row-picker">
      <view class="row-label"><text class="req">*</text>åˆ†å…¬å¸</view>
      <picker mode="selector" range="{{branchOptions}}" range-key="name" value="{{branchIndex}}" bindchange="onPickBranch" class="picker-flex">
        <view class="picker-text {{branchIndex>=0?'':'placeholder'}}">
          {{ branchIndex>=0 ? branchOptions[branchIndex].name : 'è¯·é€‰æ‹©åˆ†å…¬å¸' }}
        </view>
      </picker>
      <view class="row-arrow">â€º</view>
    </view>

    <view wx:if="{{showTypePicker}}" class="row-picker">
      <view class="row-label"><text class="req">*</text>åˆåŒç±»å‹</view>
      <picker mode="selector" range="{{typeOptions}}" range-key="name" value="{{typeIndex}}" bindchange="onPickType" class="picker-flex">
        <view class="picker-text {{typeIndex>=0?'':'placeholder'}}">
          {{ typeIndex>=0 ? typeOptions[typeIndex].name : 'è¯·é€‰æ‹©åˆåŒç±»å‹' }}
        </view>
      </picker>
      <view class="row-arrow">â€º</view>
    </view>

    <view class="row-picker no-border">
      <view class="row-label"><text class="req">*</text>é€‰æ‹©è½¦è¾†</view>
      <picker mode="selector" range="{{vehiclePickerRange}}" value="{{vehiclePickerIndex}}" bindchange="onVehiclePickChange" class="picker-flex">
        <view class="picker-text {{vehiclePickerIndex>=0?'':'placeholder'}}">
          {{ vehiclePickerIndex >= 0 ? vehiclePickerRange[vehiclePickerIndex] : 'è¯·é€‰æ‹©å¯ç”¨è½¦è¾†' }}
        </view>
      </picker>
      <view class="row-arrow">â€º</view>
    </view>
  </view>

  <view class="header" wx:if="{{mode!=='create'}}">
    <view class="header-tag">{{util.def(city)}}</view>
    <view class="header-info">
      <text class="mode-text">{{mode === 'view' ? 'æŸ¥çœ‹è¯¦æƒ…' : 'ç¼–è¾‘åˆåŒ'}}</text>
      <text class="type-text">{{selectedTypeName || 'çº¯ç§Ÿç§Ÿèµ'}}</text>
    </view>
  </view>

  <form bindsubmit="onSubmit">
    <view class="section-card form-card">
      <view class="card-title" wx:if="{{mode==='create'}}">å¡«å†™åˆåŒè¯¦æƒ…</view>
      
      <view class="form-wrap">
        <block wx:for="{{visibleFields || []}}" wx:key="name">
          <block wx:if="{{!(mode==='create' && item.hideOnCreate)}}">
            
            <block wx:if="{{ (item.name!=='rentMonthly' && item.name!=='rentToday') || selectedTypeCode !== 'rent_rto' }}">
            
              <view class="form-item item-{{item.name}}">
                <label class="label">
                  <text wx:if="{{item.required}}" class="req">*</text>{{item.label}}
                  <text class="tip" wx:if="{{item.help}}">({{item.help}})</text>
                </label>

                <input wx:if="{{item.type==='string'}}" class="input-box" placeholder="è¯·è¾“å…¥{{item.label}}" placeholder-class="ph" value="{{ (mode==='view' || item.disabled) ? util.def(form[item.name]) : (form[item.name] || '') }}" bindinput="onInput" data-name="{{item.name}}" disabled="{{item.disabled || mode==='view'}}" maxlength="{{item.maxLength || -1}}" />

                <input wx:elif="{{item.type==='number'}}" class="input-box" type="number" placeholder="0" placeholder-class="ph" value="{{ (mode==='view' || item.disabled) ? util.def(form[item.name]) : (form[item.name] !== undefined ? form[item.name] : '') }}" bindinput="onInputNumber" data-name="{{item.name}}" disabled="{{item.disabled || mode==='view'}}" />

                <picker wx:elif="{{item.type==='date'}}" mode="date" value="{{form[item.name] || ''}}" bindchange="onDateChange" data-name="{{item.name}}" disabled="{{item.disabled || mode==='view'}}">
                  <view class="input-box picker-box {{form[item.name]?'':'ph'}}">
                    {{ (mode==='view' || item.disabled) ? util.def(form[item.name]) : (form[item.name] || 'è¯·é€‰æ‹©æ—¥æœŸ') }}
                    <text class="date-icon" wx:if="{{mode!=='view'}}">ğŸ“…</text>
                  </view>
                </picker>
              </view>

            </block>
          </block>
        </block>

        <block wx:if="{{selectedTypeCode === 'rent_rto' && mode === 'create'}}">
          <view class="divider" style="height:1rpx; background:#f0f0f0; margin: 20rpx 0;"></view>
          
          <view class="form-item">
            <label class="label"><text class="req">*</text>1â€”12æœŸæ¯æœŸç§Ÿé‡‘</label>
            <input class="input-box" type="number" placeholder="0" placeholder-class="ph" value="{{form.rentMonthlyFirstYear}}" bindinput="onInputNumber" data-name="rentMonthlyFirstYear" />
          </view>
          
          <view class="form-item">
            <label class="label"><text class="req">*</text>13â€”24æœŸæ¯æœŸç§Ÿé‡‘</label>
            <input class="input-box" type="number" placeholder="0" placeholder-class="ph" value="{{form.rentMonthlySecondYear}}" bindinput="onInputNumber" data-name="rentMonthlySecondYear" />
          </view>
          
          <view class="form-item">
            <label class="label"><text class="req">*</text>ç­¾å®šä¹‹æ—¥èµ·è‡ªç„¶æ—¥å†…æ”¯ä»˜</label>
            <input class="input-box" type="number" placeholder="è¯·è¾“å…¥å¤©æ•°" placeholder-class="ph" value="{{form.daysTillPayment}}" bindinput="onInputNumber" data-name="daysTillPayment" />
          </view>
          
          <view class="form-item">
            <label class="label"><text class="req">*</text>çº¦å®šè´­ä¹°è½¦è¾†é‡‘é¢</label>
            <input class="input-box" type="number" placeholder="0" placeholder-class="ph" value="{{form.sellPrice}}" bindinput="onInputNumber" data-name="sellPrice" />
          </view>

          <view class="form-item">
            <label class="label">åˆåŒå®Œç»“åè´­è½¦å¤‡æ³¨</label>
            <input class="input-box" placeholder="å¦‚ä¸å¡«åˆ™æ˜¾ç¤ºâ€œæ— â€" placeholder-class="ph" value="{{form.notesWhenSell}}" bindinput="onInput" data-name="notesWhenSell" />
          </view>
        </block>
        </view>
    </view>

    <view wx:if="{{mode!=='view'}}" class="footer-actions">
      <button type="primary" bindtap="onSubmit" loading="{{saving}}" disabled="{{saving}}" class="submit-btn">
        {{ mode==='create' ? 'ç”ŸæˆåˆåŒ' : 'ä¿å­˜ä¿®æ”¹å¹¶é‡æ–°ç”Ÿæˆ' }}
      </button>
    </view>
  </form>

  <view class="btn-row" wx:if="{{mode==='view'}}">
    <button type="default" class="btn-edit" bindtap="toEdit">ä¿®æ”¹åˆåŒä¿¡æ¯</button>
  </view>
</view>