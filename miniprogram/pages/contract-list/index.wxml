<view class="container">
  <view class="header">
    <text class="title">{{city}} - 合同中心</text>
  </view>

  <!-- 新增：顶部筛选 tabs -->
  <view class="tabs">
    <view class="tab {{filter=='all'?'on':''}}" data-filter="all" bindtap="onFilterTap">全部</view>
    <view class="tab {{filter=='waiting'?'on':''}}" data-filter="waiting" bindtap="onFilterTap">待签</view>
    <!-- <view class="tab {{filter=='signed'?'on':''}}" data-filter="signed" bindtap="onFilterTap">已签</view> -->
    <!-- <view class="tab {{filter=='history'?'on':''}}" data-filter="history" bindtap="onFilterTap">历史</view> -->
  </view>

  <view wx:if="{{loading}}" class="empty">加载中...</view>
  <view wx:elif="{{list.length === 0}}" class="empty">暂无合同</view>

  <block wx:for="{{list}}" wx:key="_id">
    <view class="row">
      <view class="row-main">
        <!-- 有文件：可点 -->
        <view
            wx:if="{{ item.file && (item.file.pdfFileID || item.file.docxFileID) }}"
            class="file-title clickable"
            bindtap="openDocFromRow"
            data-id="{{item._id}}"
        >
            <text class="name">{{item.fields.clientName || '（未命名）'}}</text>
            <text class="plate">{{item.fields.carPlate || '无牌照'}}</text>
        </view>
        <!-- 无文件：禁用态 -->
        <view wx:else class="file-title disabled">
          <text class="name">{{item.fields.clientName || '（未命名）'}}</text>
          <text class="plate">{{item.fields.carPlate || '无牌照'}}</text>
        </view>
        <!-- 取消显示文件
        <view class="sub">
          {{item.fields.contractSerialNumberFormatted || '—'}}
        </view>
         -->
        <view class="sub">
          {{item._createTime || '—'}}
        </view>
        <view class="sub">
          <!--{{item.branchName || '—'}}｜--> {{item.contractTypeName || '—'}}
        </view>
        <view class="sub status-line">
            <view>签署状态：{{item._signStatusText|| '未获取'}}</view>
        </view>
        <!-- 暂时取消司机详情页 
        <view class="driver-action">
          <button
            class="mini-op"
            size="mini"
            type="default"
            bindtap="onOpenDriverCenter"
            data-client-id="{{item.fields.clientId}}"
            data-name="{{item.fields.clientName}}"
          >司机详情</button>
        </view> -->
      </view>

      <!-- 右侧操作区保留 -->
      <view class="ops">
        <view class="icon-row">
            <view class="icon-btn" hover-class="icon-btn--hover" bindtap="editOne" data-id="{{item._id}}">
                <image class="icon" src="/assets/icons/edit64.png" mode="widthFix" />
            </view>
            <!-- 暂时关闭软删除，隐藏删除按钮 -->
            <!-- 
            <view class="icon-btn danger" hover-class="icon-btn--hover" bindtap="delOne" data-id="{{item._id}}">
                <image class="icon" src="/assets/icons/delete64.png" mode="widthFix" />
            </view>
            --> 
        </view>

        <!-- 新增：发起签署并拿链接 -->
        <button
            class="mini-op"
            data-id="{{item._id}}"
            bindtap="onSignFromRow"
            size="mini"
            type="primary"
            loading="{{runningId === item._id}}"
        >发起签署</button>
        <button
            class="mini-op refresh-btn"
            size="mini"
            type="default"
            bindtap="onRefreshSignTaskStatus"
            data-id="{{item._id}}"
            data-sign-task-id="{{item.esign.signTaskId}}"
            loading="{{refreshingId === item._id}}"
            disabled="{{item._refreshDisabled}}"
        >{{item._refreshButtonText || '刷新状态'}}</button>
        <button
            data-id="{{item._id}}"
            bindtap="onGetDownloadUrlFromRow"
            size="mini"
            disabled="{{!item.esign || !item.esign.signTaskId}}"
        >获取下载</button>
      </view>
      <!-- 调试用，看看最后拿到的链接 -->
      <!-- <text selectable="true">{{lastEsignUrl}}</text>-->
    </view>
  </block>

  <view class="load-more" wx:if="{{hasMore}}">
    <button size="mini" bindtap="loadMore">加载更多</button>
  </view>
</view>
