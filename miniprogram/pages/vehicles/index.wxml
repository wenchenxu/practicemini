<wxs src="../../utils/fmt.wxs" module="fmt" />
<view class="page-container">
  
  <van-dropdown-menu active-color="#1989fa">
    <van-dropdown-item value="{{ cityCode }}" options="{{ cityOptions }}" bind:change="onCityChange" />
    <van-dropdown-item value="{{ timeRange }}" options="{{ rangeOptions }}" bind:change="onRangeChange" />
  </van-dropdown-menu>

  <view class="card-box overview-card">
    <view class="overview-header">当前存量概览</view>
    <view class="overview-content">
      
      <view class="chart-area">
        <van-circle
          value="{{ stats.utilizationRate }}" 
          color="{{ stats.utilizationRate > 80 ? '#07c160' : '#1989fa' }}"
          layer-color="#ebedf0"
          size="100"
          stroke-width="6"
        >
          <view class="circle-text">
            <view class="rate-num">{{ stats.utilization }}<text class="unit">%</text></view>
            <view class="rate-label">出租率</view>
          </view>
        </van-circle>
      </view>

      <view class="grid-area">
        <view class="stat-item">
          <view class="stat-val">{{ stats.total }}</view>
          <view class="stat-key">总车辆</view>
        </view>
        <view class="stat-item">
          <view class="stat-val text-green">{{ stats.rented }}</view>
          <view class="stat-key">在租</view>
        </view>
        <view class="stat-item">
          <view class="stat-val text-blue">{{ stats.available }}</view>
          <view class="stat-key">闲置</view>
        </view>
        <view class="stat-item">
          <view class="stat-val text-orange">{{ stats.maintenance }}</view>
          <view class="stat-key">维修中</view>
        </view>
      </view>
    </view>
  </view>

  <view class="card-box warning-card" wx:if="{{ expiring.length > 0 }}" bindtap="onViewDetail" data-type="expiring">
    <van-icon name="warning" color="#ff976a" size="20px" style="margin-right: 10rpx;" />
    <text>有 {{ expiring.length }} 辆车保险/年审即将到期</text>
    <van-icon name="arrow" color="#969799" style="margin-left: auto;" />
  </view>

  <view class="section-title">
    <text wx:if="{{timeRange==='today'}}">今日</text>
    <text wx:elif="{{timeRange==='week'}}">本周</text>
    <text wx:else>本月</text>
    业务流水
  </view>
  
  <view class="card-box flow-list">
    <van-cell-group border="{{false}}">
      <van-cell title="新租出车辆" is-link value="{{ flow.rentOut.length }} 辆" bind:click="onViewDetail" data-type="rentOut">
        <view slot="icon" class="cell-icon icon-out">出</view>
      </van-cell>
      
      <van-cell title="退租入库" is-link value="{{ flow.return.length }} 辆" bind:click="onViewDetail" data-type="return">
        <view slot="icon" class="cell-icon icon-in">入</view>
      </van-cell>

      <van-cell title="送修/事故" is-link value="{{ flow.maintenanceIn.length }} 辆" bind:click="onViewDetail" data-type="maintenanceIn">
        <view slot="icon" class="cell-icon icon-fix">修</view>
      </van-cell>
    </van-cell-group>
  </view>

  <van-popup
    show="{{ showDetail }}"
    position="bottom"
    round
    closeable
    bind:close="onCloseDetail"
    custom-style="height: 60%;"
  >
    <view class="popup-title">{{ detailTitle }}</view>
    <scroll-view scroll-y style="height: calc(100% - 100rpx);">
      <view wx:if="{{ detailList.length === 0 }}" style="padding: 100rpx 0;">
        <van-empty description="无详细记录" />
      </view>
      
      <van-cell-group>
        <block wx:for="{{ detailList }}" wx:key="index">
          <van-cell 
            title="{{ item.plate }}" 
            use-label-slot
          >
            <view slot="label">
              {{ item.liabInsEnd ? '保险到期' : fmt.formatTime(item.createdAt) }}
            </view>

            <view slot="right-icon" style="font-size: 26rpx; color: #333; font-weight: 500;">
               {{ item.driverName || item.clientName || item.driverClientId || '-' }}
            </view>
          </van-cell>
        </block>
      </van-cell-group>
    </scroll-view>
  </van-popup>

</view>